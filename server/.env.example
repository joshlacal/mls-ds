# Docker Compose Environment Configuration
# Copy this file to .env and update with your values

# PostgreSQL Configuration
POSTGRES_PASSWORD=changeme_secure_password
POSTGRES_USER=catbird
POSTGRES_DB=catbird

# Redis Configuration
REDIS_PASSWORD=changeme_redis_password
REDIS_ENCRYPTION_KEY=base64-encoded-32-byte-key

# Application Configuration
# WebSocket subscription ticket signing secret.
TICKET_SECRET=replace-with-strong-ticket-secret

# Logging Configuration
# CRITICAL: Always set RUST_LOG=warn in production
# Higher log levels leak identity-bearing metadata:
#   - info: Logs operational detail that may expose patterns
#   - debug: May log hashed IDs (for debugging only)
#   - trace: Development only, never in production
#
# Safe production values:
#   - warn: Recommended (errors and warnings only)
#   - error: Ultra-minimal (errors only)
#
# For targeted debugging in production:
#   RUST_LOG=warn,catbird_server::handlers::send_message=debug
#
# Default behavior (if RUST_LOG not set):
#   - Debug builds: debug level
#   - Release builds: warn level
RUST_LOG=warn

DATABASE_URL=postgresql://catbird:changeme_secure_password@postgres:5432/catbird
TEST_DATABASE_URL=postgresql://catbird:changeme_secure_password@postgres:5432/catbird_test
REDIS_URL=redis://:changeme_redis_password@redis:6379

# Server Configuration
SERVER_PORT=3000

# Service DID for inter-service JWT aud validation
SERVICE_DID=did:web:mls.example.com
# Optional: fallback proxy target for non-local /xrpc calls
PDS_XRPC_BASE=https://bsky.social

# Data Retention (Compaction Worker)
# How long to keep messages before deletion (in days)
MESSAGE_TTL_DAYS=30
# How long to keep event stream entries before deletion (in days)
EVENT_STREAM_TTL_DAYS=7

# Delivery ACK cleanup worker interval (seconds)
# Default: 86400 (daily)
CLEANUP_INTERVAL_SECS=86400

# Key Package Limits (Cleanup Worker)
# Maximum number of key packages allowed per device
MAX_KEY_PACKAGES_PER_DEVICE=200

# Recovery mode in-memory limiter cache settings
# Applies to both cooldown and hourly counters
KEY_PACKAGE_RECOVERY_CACHE_CAPACITY=10000
KEY_PACKAGE_RECOVERY_CACHE_TTL_SECS=3600

# Rate Limiting Configuration
# Per-IP rate limiting (unauthenticated requests)
RATE_LIMIT_IP_PER_MINUTE=60          # Requests per minute per IP
IP_RATE_BURST=60                      # Burst capacity (defaults to per-minute quota)
RATE_LIMIT_IP_MAX_KEYS=100000         # Max distinct IP keys kept in cache
TRUSTED_PROXY_CIDRS=                  # Example: 173.245.48.0/20,103.21.244.0/22

# Per-DID endpoint-specific rate limiting (authenticated requests)
RATE_LIMIT_SEND_MESSAGE=100           # High frequency messaging (per DID per minute)
RATE_LIMIT_PUBLISH_KEY_PACKAGE=20     # Batch key package uploads (per DID per minute)
RATE_LIMIT_ADD_MEMBERS=10             # Admin operations: add members (per DID per minute)
RATE_LIMIT_CREATE_CONVO=5             # Expensive: create conversation (per DID per minute)
RATE_LIMIT_REPORT_MEMBER=5            # Prevent report spam (per DID per minute)
RATE_LIMIT_DID_DEFAULT=200            # Default for other operations (per DID per minute)
RATE_LIMIT_DID_MAX_KEYS=300000        # Max distinct DID:endpoint keys kept in cache

# Federation DS peer rate limits (per source DS DID per minute)
FEDERATION_RATE_LIMIT_DELIVER_MESSAGE=240
FEDERATION_RATE_LIMIT_DELIVER_WELCOME=120
FEDERATION_RATE_LIMIT_SUBMIT_COMMIT=120
FEDERATION_RATE_LIMIT_FETCH_KEY_PACKAGE=120
FEDERATION_RATE_LIMIT_TRANSFER_SEQUENCER=30
FEDERATION_RATE_LIMIT_DEFAULT=180
RATE_LIMIT_FEDERATION_MAX_KEYS=100000

# Federation transport policy
# Keep false in production; only true for trusted local/dev federation testing
FEDERATION_ALLOW_INSECURE_HTTP=false
FEDERATION_OUTBOUND_HOST_ALLOWLIST=   # Optional comma-separated host suffix allowlist
FEDERATION_DNS_TIMEOUT_MS=3000

# Operator DIDs allowed to manage federation peer policy endpoints.
# Comma-separated canonical DIDs (no fragments needed).
FEDERATION_ADMIN_DIDS=did:plc:admin1,did:plc:admin2

# DID resolution controls
DID_RESOLUTION_TIMEOUT_SECONDS=10
DID_RESOLUTION_HOST_ALLOWLIST=         # Optional comma-separated host suffix allowlist
