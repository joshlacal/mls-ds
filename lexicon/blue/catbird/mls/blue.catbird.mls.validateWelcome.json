{
  "lexicon": 1,
  "id": "blue.catbird.mls.validateWelcome",
  "defs": {
    "main": {
      "type": "procedure",
      "description": "Validate a Welcome message before processing and reserve the referenced key package. Prevents race conditions and helps clients detect missing bundles early.",
      "input": {
        "encoding": "application/json",
        "schema": {
          "type": "object",
          "required": ["welcomeMessage"],
          "properties": {
            "welcomeMessage": {
              "type": "bytes",
              "description": "MLS Welcome message bytes to validate",
              "maxLength": 10485760
            }
          }
        }
      },
      "output": {
        "encoding": "application/json",
        "schema": {
          "type": "object",
          "required": ["valid", "keyPackageHash"],
          "properties": {
            "valid": {
              "type": "boolean",
              "description": "Whether the Welcome message is valid and key package is available"
            },
            "keyPackageHash": {
              "type": "string",
              "description": "SHA256 hex hash of the key package referenced in the Welcome message"
            },
            "recipientDid": {
              "type": "string",
              "format": "did",
              "description": "DID of the recipient (authenticated user). Confirms Welcome is for this user."
            },
            "groupId": {
              "type": "string",
              "description": "MLS group identifier (hex-encoded) extracted from Welcome message"
            },
            "reserved": {
              "type": "boolean",
              "description": "Whether the key package was successfully reserved. If true, client should process Welcome within 5 minutes."
            },
            "reservedUntil": {
              "type": "string",
              "format": "datetime",
              "description": "Timestamp when reservation expires (5 minutes from now). Only present if reserved is true."
            }
          }
        }
      },
      "errors": [
        {
          "name": "InvalidWelcome",
          "description": "Welcome message is malformed or cannot be parsed"
        },
        {
          "name": "KeyPackageNotFound",
          "description": "Referenced key package was never uploaded by this user"
        },
        {
          "name": "KeyPackageAlreadyConsumed",
          "description": "Referenced key package has already been used"
        },
        {
          "name": "KeyPackageReserved",
          "description": "Referenced key package is reserved by another Welcome message"
        },
        {
          "name": "RecipientMismatch",
          "description": "Welcome message is not for the authenticated user"
        }
      ]
    }
  }
}
