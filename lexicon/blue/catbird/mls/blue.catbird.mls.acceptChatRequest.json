{
  "lexicon": 1,
  "id": "blue.catbird.mls.acceptChatRequest",
  "defs": {
    "main": {
      "type": "procedure",
      "description": "Accept a chat request, create MLS group, and deliver held messages",
      "input": {
        "encoding": "application/json",
        "schema": {
          "type": "object",
          "required": ["requestId"],
          "properties": {
            "requestId": {
              "type": "string",
              "description": "ID of the request to accept"
            },
            "welcomeData": {
              "type": "bytes",
              "description": "MLS Welcome message for sender to join group",
              "maxLength": 1048576
            }
          }
        }
      },
      "output": {
        "encoding": "application/json",
        "schema": {
          "type": "object",
          "required": ["convoId", "heldMessages", "acceptedAt"],
          "properties": {
            "convoId": {
              "type": "string",
              "description": "Created conversation ID"
            },
            "heldMessages": {
              "type": "array",
              "description": "Held messages now available to decrypt",
              "items": {
                "type": "ref",
                "ref": "#deliveredMessage"
              }
            },
            "acceptedAt": {
              "type": "string",
              "format": "datetime",
              "description": "Acceptance timestamp"
            }
          }
        }
      },
      "errors": [
        {"name": "RequestNotFound"},
        {"name": "RequestExpired"},
        {"name": "AlreadyProcessed"}
      ]
    },
    "deliveredMessage": {
      "type": "object",
      "required": ["id", "ciphertext", "paddedSize", "sequence"],
      "properties": {
        "id": {
          "type": "string",
          "description": "Message ID"
        },
        "ciphertext": {
          "type": "bytes",
          "description": "MLS encrypted message"
        },
        "paddedSize": {
          "type": "integer",
          "description": "Padded message size"
        },
        "sequence": {
          "type": "integer",
          "description": "Message order in request"
        },
        "ephPubKey": {
          "type": "bytes",
          "description": "Ephemeral public key if present"
        }
      }
    }
  }
}
