{
  "lexicon": 1,
  "id": "blue.catbird.mls.registerDevice",
  "description": "Register a new device identity for multi-device support",
  "defs": {
    "main": {
      "type": "procedure",
      "description": "Register a new device with the MLS server. Each device gets a unique MLS identity (did:plc:user#device-uuid). Server automatically adds device to user's existing conversations. Returns device credentials for local storage.",
      "input": {
        "encoding": "application/json",
        "schema": {
          "type": "object",
          "required": ["deviceName", "signaturePublicKey", "keyPackages"],
          "properties": {
            "deviceName": {
              "type": "string",
              "maxLength": 128,
              "description": "Human-readable device name (e.g., 'Josh's iPhone', 'Alice's MacBook Pro')"
            },
            "signaturePublicKey": {
              "type": "bytes",
              "description": "Ed25519 public key (32 bytes) derived from device's signature private key",
              "minLength": 32,
              "maxLength": 32
            },
            "keyPackages": {
              "type": "array",
              "items": {
                "type": "ref",
                "ref": "blue.catbird.mls.defs#keyPackageRef"
              },
              "description": "Initial key packages for this device (100+ recommended for optimal performance)",
              "minLength": 1,
              "maxLength": 200
            }
          }
        }
      },
      "output": {
        "encoding": "application/json",
        "schema": {
          "type": "object",
          "required": ["deviceId", "mlsDid", "autoJoinedConvos"],
          "properties": {
            "deviceId": {
              "type": "string",
              "description": "Unique device identifier (UUID generated by server)"
            },
            "mlsDid": {
              "type": "string",
              "format": "did",
              "description": "Device-specific MLS DID (format: did:plc:user#device-uuid). Use this in all MLS operations."
            },
            "autoJoinedConvos": {
              "type": "array",
              "items": {
                "type": "string"
              },
              "description": "List of conversation IDs where this device was automatically added (seamless rejoin)"
            },
            "welcomeMessages": {
              "type": "array",
              "items": {
                "type": "ref",
                "ref": "#welcomeMessageRef"
              },
              "description": "Welcome messages for each auto-joined conversation (encrypted group secrets)"
            }
          }
        }
      },
      "errors": [
        {
          "name": "InvalidKeyPackage",
          "description": "One or more key packages are invalid or malformed"
        },
        {
          "name": "DuplicatePublicKey",
          "description": "A device with this public key is already registered"
        },
        {
          "name": "TooManyDevices",
          "description": "Maximum device limit reached for this account"
        }
      ]
    },
    "welcomeMessageRef": {
      "type": "object",
      "description": "Welcome message for a conversation the device was auto-added to",
      "required": ["convoId", "welcome"],
      "properties": {
        "convoId": {
          "type": "string",
          "description": "Conversation identifier"
        },
        "welcome": {
          "type": "string",
          "description": "Base64url-encoded MLS Welcome message containing encrypted group secrets"
        }
      }
    }
  }
}
