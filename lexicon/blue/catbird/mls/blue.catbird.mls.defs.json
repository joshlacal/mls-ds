{
  "lexicon": 1,
  "id": "blue.catbird.mls.defs",
  "description": "Shared type definitions for MLS (Message Layer Security) protocol",
  "defs": {
    "convoView": {
      "type": "object",
      "description": "View of an MLS conversation with member and epoch information",
      "required": ["id", "groupId", "creator", "members", "epoch", "cipherSuite", "createdAt"],
      "properties": {
        "id": { "type": "string", "description": "Conversation identifier (TID)" },
        "groupId": {
          "type": "string",
          "description": "MLS group identifier (hex-encoded)",
          "maxLength": 128
        },
        "creator": { "type": "string", "format": "did", "description": "DID of the conversation creator" },
        "members": { "type": "array", "items": { "type": "ref", "ref": "#memberView" }, "description": "Current conversation members" },
        "epoch": { "type": "integer", "minimum": 0, "description": "Current MLS epoch number" },
        "cipherSuite": {
          "type": "string",
          "description": "MLS cipher suite used for this conversation",
          "knownValues": [
            "MLS_128_DHKEMX25519_AES128GCM_SHA256_Ed25519",
            "MLS_128_DHKEMP256_AES128GCM_SHA256_P256",
            "MLS_128_DHKEMX25519_CHACHA20POLY1305_SHA256_Ed25519",
            "MLS_256_DHKEMX448_AES256GCM_SHA512_Ed448",
            "MLS_256_DHKEMP521_AES256GCM_SHA512_P521",
            "MLS_256_DHKEMX448_CHACHA20POLY1305_SHA512_Ed448"
          ]
        },
        "createdAt": { "type": "string", "format": "datetime", "description": "Conversation creation timestamp" },
        "lastMessageAt": { "type": "string", "format": "datetime", "description": "Timestamp of last message" },
        "metadata": { "type": "ref", "ref": "#convoMetadata", "description": "Optional conversation metadata" }
      }
    },

    "convoMetadata": {
      "type": "object",
      "description": "Metadata for a conversation (name, description)",
      "properties": {
        "name": { "type": "string", "maxLength": 128, "description": "Conversation display name" },
        "description": { "type": "string", "maxLength": 512, "description": "Conversation description" }
      }
    },

    "memberView": {
      "type": "object",
      "description": "View of a conversation member representing a single device. Multiple devices per user appear as separate members in MLS layer, but UI should group by userDid.",
      "required": ["did", "userDid", "joinedAt", "isAdmin"],
      "properties": {
        "did": {
          "type": "string",
          "format": "did",
          "description": "Device-specific MLS DID (format: did:plc:user#device-uuid). Used in MLS operations."
        },
        "userDid": {
          "type": "string",
          "format": "did",
          "description": "User DID without device suffix (format: did:plc:user). Used for UI grouping and admin status sync."
        },
        "deviceId": {
          "type": "string",
          "description": "Device identifier (UUID). Unique per device."
        },
        "deviceName": {
          "type": "string",
          "maxLength": 128,
          "description": "Human-readable device name (e.g., 'Josh's iPhone'). Optional, may be null for legacy members."
        },
        "joinedAt": { "type": "string", "format": "datetime", "description": "When this device joined the conversation" },
        "isAdmin": {
          "type": "boolean",
          "description": "Whether this member (device) has admin privileges. Admin status is synced across all devices of the same user."
        },
        "promotedAt": {
          "type": "string",
          "format": "datetime",
          "description": "When member was promoted to admin (if applicable)"
        },
        "promotedBy": {
          "type": "string",
          "format": "did",
          "description": "DID of admin who promoted this member (if applicable)"
        },
        "leafIndex": { "type": "integer", "minimum": 0, "description": "MLS leaf index in ratchet tree structure" },
        "credential": { "type": "bytes", "description": "MLS credential bytes" }
      }
    },

    "messageView": {
      "type": "object",
      "description": "View of an encrypted MLS message. Server follows 'dumb delivery service' model - sender identity must be derived by clients from decrypted MLS content for metadata privacy.",
      "required": ["id", "convoId", "ciphertext", "epoch", "seq", "createdAt"],
      "properties": {
        "id": { "type": "string", "description": "Message identifier (ULID for deduplication)" },
        "convoId": { "type": "string", "description": "Conversation identifier" },
        "ciphertext": { "type": "bytes", "description": "MLS encrypted message ciphertext bytes", "maxLength": 10485760 },
        "epoch": { "type": "integer", "minimum": 0, "description": "MLS epoch when message was sent" },
        "seq": { "type": "integer", "minimum": 0, "description": "Sequence number within conversation" },
        "createdAt": { "type": "string", "format": "datetime", "description": "Message creation timestamp (bucketed to 2-second intervals for traffic analysis protection)" }
      }
    },

    "keyPackageRef": {
      "type": "object",
      "description": "Reference to an MLS key package for adding members",
      "required": ["did", "keyPackage", "cipherSuite"],
      "properties": {
        "did": { "type": "string", "format": "did", "description": "Owner DID" },
        "keyPackage": { "type": "string", "description": "Base64url-encoded MLS key package bytes" },
        "cipherSuite": {
          "type": "string",
          "description": "Supported cipher suite for this key package",
          "knownValues": [
            "MLS_128_DHKEMX25519_AES128GCM_SHA256_Ed25519",
            "MLS_128_DHKEMP256_AES128GCM_SHA256_P256",
            "MLS_128_DHKEMX25519_CHACHA20POLY1305_SHA256_Ed25519",
            "MLS_256_DHKEMX448_AES256GCM_SHA512_Ed448",
            "MLS_256_DHKEMP521_AES256GCM_SHA512_P521",
            "MLS_256_DHKEMX448_CHACHA20POLY1305_SHA512_Ed448"
          ]
        }
      }
    }
  }
}
