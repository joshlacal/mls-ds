{
  "lexicon": 1,
  "id": "blue.catbird.mls.sendChatRequest",
  "defs": {
    "main": {
      "type": "procedure",
      "description": "Send a chat request to a user not yet in conversation. The request holds encrypted message(s) until accepted.",
      "input": {
        "encoding": "application/json",
        "schema": {
          "type": "object",
          "required": ["recipientDid"],
          "properties": {
            "recipientDid": {
              "type": "string",
              "description": "DID of the user to send chat request to"
            },
            "previewText": {
              "type": "string",
              "description": "Optional short plain-text preview message (not E2EE, max 200 chars)",
              "maxLength": 200
            },
            "heldMessages": {
              "type": "array",
              "description": "Encrypted messages to hold until request accepted (max 5)",
              "maxItems": 5,
              "items": {
                "type": "ref",
                "ref": "#heldMessage"
              }
            },
            "isGroupInvite": {
              "type": "boolean",
              "description": "If true, this is an invite to an existing group",
              "default": false
            },
            "groupId": {
              "type": "string",
              "description": "Conversation ID if this is a group invite"
            }
          }
        }
      },
      "output": {
        "encoding": "application/json",
        "schema": {
          "type": "object",
          "required": ["requestId", "status", "createdAt", "expiresAt"],
          "properties": {
            "requestId": {
              "type": "string",
              "description": "Unique request identifier (ULID)"
            },
            "status": {
              "type": "string",
              "enum": ["pending", "bypassed"],
              "description": "Request status (bypassed if social graph allows)"
            },
            "createdAt": {
              "type": "string",
              "format": "datetime",
              "description": "Request creation timestamp"
            },
            "expiresAt": {
              "type": "string",
              "format": "datetime",
              "description": "Request expiration timestamp"
            },
            "convoId": {
              "type": "string",
              "description": "Conversation ID if request was bypassed"
            }
          }
        }
      },
      "errors": [
        {"name": "BlockedByRecipient"},
        {"name": "RateLimited"},
        {"name": "RecipientNotFound"},
        {"name": "DuplicateRequest"},
        {"name": "SelfRequest"}
      ]
    },
    "heldMessage": {
      "type": "object",
      "required": ["ciphertext", "paddedSize"],
      "properties": {
        "ciphertext": {
          "type": "bytes",
          "description": "MLS encrypted message ciphertext",
          "maxLength": 10485760
        },
        "paddedSize": {
          "type": "integer",
          "minimum": 512,
          "maximum": 10485760,
          "description": "Padded ciphertext size (power of 2 buckets)"
        },
        "ephPubKey": {
          "type": "bytes",
          "description": "Optional ephemeral public key for forward secrecy",
          "maxLength": 256
        }
      }
    }
  }
}
