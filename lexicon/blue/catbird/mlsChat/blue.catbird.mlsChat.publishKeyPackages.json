{
  "lexicon": 1,
  "id": "blue.catbird.mlsChat.publishKeyPackages",
  "description": "Unified key package management: publish new packages or sync with server (consolidates publishKeyPackages + syncKeyPackages + getKeyPackageStats)",
  "defs": {
    "main": {
      "type": "procedure",
      "description": "Manage key packages for the authenticated user's device. Supports two actions: 'publish' uploads new key packages, 'sync' compares local hashes against server to clean up orphaned packages. Both actions return current stats.",
      "input": {
        "encoding": "application/json",
        "schema": {
          "type": "object",
          "required": ["action"],
          "properties": {
            "action": {
              "type": "string",
              "description": "Action to perform: 'publish' to upload new key packages, 'sync' to reconcile local/server state",
              "knownValues": ["publish", "sync"]
            },
            "keyPackages": {
              "type": "array",
              "description": "Key packages to upload (required for 'publish' action, max 100)",
              "maxItems": 100,
              "items": {
                "type": "ref",
                "ref": "#keyPackageItem"
              }
            },
            "localHashes": {
              "type": "array",
              "items": { "type": "string" },
              "maxLength": 200,
              "description": "SHA256 hex hashes of key packages that exist in local storage (required for 'sync' action)"
            },
            "deviceId": {
              "type": "string",
              "description": "Device ID to scope the operation. Required for 'sync', recommended for 'publish'."
            }
          }
        }
      },
      "output": {
        "encoding": "application/json",
        "schema": {
          "type": "object",
          "required": ["stats"],
          "properties": {
            "stats": {
              "type": "ref",
              "ref": "#keyPackageStats",
              "description": "Current key package statistics after the operation"
            },
            "syncResult": {
              "type": "ref",
              "ref": "#syncResult",
              "description": "Detailed sync results (only present when action is 'sync')"
            },
            "publishResult": {
              "type": "ref",
              "ref": "#publishResult",
              "description": "Detailed publish results (only present when action is 'publish')"
            }
          }
        }
      },
      "errors": [
        {"name": "InvalidAction", "description": "Action must be 'publish' or 'sync'"},
        {"name": "MissingKeyPackages", "description": "keyPackages required for 'publish' action"},
        {"name": "MissingLocalHashes", "description": "localHashes required for 'sync' action"},
        {"name": "MissingDeviceId", "description": "deviceId required for 'sync' action"},
        {"name": "BatchTooLarge", "description": "Batch size exceeds maximum of 100 key packages"},
        {"name": "InvalidBatch", "description": "Batch validation failed"}
      ]
    },
    "keyPackageItem": {
      "type": "object",
      "required": ["keyPackage", "cipherSuite", "expires"],
      "properties": {
        "keyPackage": {
          "type": "string",
          "description": "Base64-encoded MLS key package",
          "maxLength": 65536
        },
        "cipherSuite": {
          "type": "string",
          "description": "Cipher suite of the key package",
          "knownValues": [
            "MLS_128_DHKEMX25519_AES128GCM_SHA256_Ed25519",
            "MLS_128_DHKEMP256_AES128GCM_SHA256_P256",
            "MLS_128_DHKEMX25519_CHACHA20POLY1305_SHA256_Ed25519",
            "MLS_256_DHKEMX448_AES256GCM_SHA512_Ed448",
            "MLS_256_DHKEMP521_AES256GCM_SHA512_P521",
            "MLS_256_DHKEMX448_CHACHA20POLY1305_SHA512_Ed448"
          ]
        },
        "expires": {
          "type": "string",
          "format": "datetime",
          "description": "Expiration timestamp (required, max 90 days from now)"
        }
      }
    },
    "keyPackageStats": {
      "type": "object",
      "required": ["published", "available", "expired"],
      "properties": {
        "published": {
          "type": "integer",
          "minimum": 0,
          "description": "Total key packages ever published for this device"
        },
        "available": {
          "type": "integer",
          "minimum": 0,
          "description": "Currently available (unconsumed, non-expired) key packages"
        },
        "expired": {
          "type": "integer",
          "minimum": 0,
          "description": "Number of expired key packages pending cleanup"
        }
      }
    },
    "syncResult": {
      "type": "object",
      "required": ["serverHashes", "orphanedCount", "deletedCount", "deviceId"],
      "properties": {
        "serverHashes": {
          "type": "array",
          "items": { "type": "string" },
          "description": "SHA256 hex hashes of available key packages on server AFTER cleanup"
        },
        "orphanedCount": {
          "type": "integer",
          "minimum": 0,
          "description": "Number of orphaned key packages detected"
        },
        "deletedCount": {
          "type": "integer",
          "minimum": 0,
          "description": "Number of orphaned key packages successfully deleted"
        },
        "remainingAvailable": {
          "type": "integer",
          "minimum": 0,
          "description": "Number of valid key packages remaining after cleanup"
        },
        "deviceId": {
          "type": "string",
          "description": "Device ID that was synced (echoed back for confirmation)"
        }
      }
    },
    "publishResult": {
      "type": "object",
      "required": ["succeeded", "failed"],
      "properties": {
        "succeeded": {
          "type": "integer",
          "minimum": 0,
          "description": "Number of key packages successfully uploaded"
        },
        "failed": {
          "type": "integer",
          "minimum": 0,
          "description": "Number of key packages that failed to upload"
        },
        "errors": {
          "type": "array",
          "description": "Detailed error information for failed uploads",
          "items": {
            "type": "ref",
            "ref": "#batchError"
          }
        }
      }
    },
    "batchError": {
      "type": "object",
      "required": ["index", "error"],
      "properties": {
        "index": {
          "type": "integer",
          "minimum": 0,
          "description": "Zero-based index of the key package that failed"
        },
        "error": {
          "type": "string",
          "description": "Human-readable error message"
        }
      }
    }
  }
}
