{
  "lexicon": 1,
  "id": "blue.catbird.mlsChat.getMessages",
  "description": "Retrieve messages from a conversation with type filtering (consolidates getMessages + getCommits)",
  "defs": {
    "main": {
      "type": "query",
      "description": "Retrieve messages from an MLS conversation. Messages are GUARANTEED to be returned in MLS sequential order (epoch ASC, seq ASC). Clients MUST process messages in this order for proper MLS decryption. The 'type' filter replaces the separate getCommits endpoint.",
      "parameters": {
        "type": "params",
        "required": ["convoId"],
        "properties": {
          "convoId": {
            "type": "string",
            "description": "Conversation identifier"
          },
          "limit": {
            "type": "integer",
            "minimum": 1,
            "maximum": 100,
            "default": 50,
            "description": "Maximum number of messages to return"
          },
          "sinceSeq": {
            "type": "integer",
            "minimum": 0,
            "description": "Fetch messages with seq > sinceSeq (pagination cursor)"
          },
          "type": {
            "type": "string",
            "description": "Filter by message type: 'app' for user content only, 'commit' for MLS protocol control messages only, 'all' for both",
            "knownValues": ["app", "commit", "all"],
            "default": "all"
          }
        }
      },
      "output": {
        "encoding": "application/json",
        "schema": {
          "type": "object",
          "required": ["messages"],
          "properties": {
            "messages": {
              "type": "array",
              "items": {
                "type": "ref",
                "ref": "blue.catbird.mlsChat.defs#messageView"
              },
              "description": "Messages in MLS sequential order (epoch ASC, seq ASC)"
            },
            "lastSeq": {
              "type": "integer",
              "description": "Sequence number of the last message in this response. Use as sinceSeq for next page."
            },
            "gapInfo": {
              "type": "ref",
              "ref": "#gapInfo",
              "description": "Gap detection metadata for missing messages"
            }
          }
        }
      },
      "errors": [
        {"name": "ConvoNotFound", "description": "Conversation not found"},
        {"name": "NotMember", "description": "Caller is not a member of the conversation"},
        {"name": "InvalidCursor", "description": "sinceSeq parameter is invalid or exceeds available messages"}
      ]
    },
    "gapInfo": {
      "type": "object",
      "required": ["hasGaps", "missingSeqs", "totalMessages"],
      "properties": {
        "hasGaps": {
          "type": "boolean",
          "description": "Whether there are gaps in the sequence number range"
        },
        "missingSeqs": {
          "type": "array",
          "items": { "type": "integer" },
          "description": "Array of missing sequence numbers"
        },
        "totalMessages": {
          "type": "integer",
          "minimum": 0,
          "description": "Total number of messages in the conversation"
        }
      }
    }
  }
}
