{
  "lexicon": 1,
  "id": "blue.catbird.mlsChat.blocks",
  "description": "Manage Bluesky block relationships for MLS conversations (consolidates checkBlocks + getBlockStatus + handleBlockChange)",
  "defs": {
    "main": {
      "type": "procedure",
      "description": "Check, query, or handle Bluesky block relationships relevant to MLS conversations. The 'action' field determines the operation.",
      "input": {
        "encoding": "application/json",
        "schema": {
          "type": "object",
          "required": ["action"],
          "properties": {
            "action": {
              "type": "string",
              "description": "Block operation: 'check' queries Bluesky for block relationships between DIDs, 'getStatus' returns blocks within a conversation, 'handleChange' processes a block/unblock event from Bluesky firehose",
              "knownValues": ["check", "getStatus", "handleChange"]
            },
            "dids": {
              "type": "array",
              "items": {
                "type": "string",
                "format": "did"
              },
              "description": "DIDs to check for mutual blocks (required for 'check', 2-100 users)",
              "maxLength": 100
            },
            "convoId": {
              "type": "string",
              "description": "Conversation identifier (required for 'getStatus')"
            },
            "did": {
              "type": "string",
              "format": "did",
              "description": "DID involved in the block change (for 'handleChange')"
            },
            "blockRecord": {
              "type": "ref",
              "ref": "#blockChangeRecord",
              "description": "Block/unblock event data from Bluesky firehose (for 'handleChange')"
            }
          }
        }
      },
      "output": {
        "encoding": "application/json",
        "schema": {
          "type": "object",
          "properties": {
            "blocked": {
              "type": "boolean",
              "description": "Whether any blocks exist (for 'check')"
            },
            "blocks": {
              "type": "array",
              "items": {
                "type": "ref",
                "ref": "#blockRelationship"
              },
              "description": "Block relationships found (for 'check' and 'getStatus')"
            },
            "hasConflicts": {
              "type": "boolean",
              "description": "Whether any conversation members have blocked each other (for 'getStatus')"
            },
            "checkedAt": {
              "type": "string",
              "format": "datetime",
              "description": "When the block status was checked"
            },
            "changes": {
              "type": "array",
              "items": {
                "type": "ref",
                "ref": "#blockChangeResult"
              },
              "description": "Results of handling block changes (for 'handleChange')"
            },
            "status": {
              "type": "ref",
              "ref": "#conversationBlockStatus",
              "description": "Full conversation block status (for 'getStatus')"
            }
          }
        }
      },
      "errors": [
        {"name": "InvalidAction", "description": "Unknown action value"},
        {"name": "MissingDids", "description": "dids is required for 'check'"},
        {"name": "TooManyDids", "description": "Too many DIDs provided (max 100)"},
        {"name": "ConvoNotFound", "description": "Conversation not found (for 'getStatus')"},
        {"name": "NotMember", "description": "Caller is not a member (for 'getStatus')"},
        {"name": "NotAdmin", "description": "Admin privileges required (for 'getStatus')"},
        {"name": "BlueskyServiceUnavailable", "description": "Could not reach Bluesky service"}
      ]
    },
    "blockRelationship": {
      "type": "object",
      "required": ["blockerDid", "blockedDid", "createdAt"],
      "properties": {
        "blockerDid": {
          "type": "string",
          "format": "did",
          "description": "DID of user who created the block"
        },
        "blockedDid": {
          "type": "string",
          "format": "did",
          "description": "DID of user who was blocked"
        },
        "createdAt": {
          "type": "string",
          "format": "datetime",
          "description": "When the block was created"
        },
        "blockUri": {
          "type": "string",
          "format": "at-uri",
          "description": "AT-URI of the block record on Bluesky"
        }
      }
    },
    "blockChangeRecord": {
      "type": "object",
      "required": ["action", "blockerDid", "blockedDid"],
      "properties": {
        "action": {
          "type": "string",
          "description": "Whether a block was created or deleted",
          "knownValues": ["block", "unblock"]
        },
        "blockerDid": {
          "type": "string",
          "format": "did",
          "description": "DID of the blocker"
        },
        "blockedDid": {
          "type": "string",
          "format": "did",
          "description": "DID of the blocked user"
        },
        "blockUri": {
          "type": "string",
          "format": "at-uri",
          "description": "AT-URI of the block record"
        }
      }
    },
    "blockChangeResult": {
      "type": "object",
      "required": ["convoId", "action"],
      "properties": {
        "convoId": {
          "type": "string",
          "description": "Affected conversation"
        },
        "action": {
          "type": "string",
          "description": "Action taken in response to block change",
          "knownValues": ["memberRemoved", "notificationSent", "noAction"]
        },
        "removedDid": {
          "type": "string",
          "format": "did",
          "description": "DID of member removed (if action is memberRemoved)"
        }
      }
    },
    "conversationBlockStatus": {
      "type": "object",
      "required": ["convoId", "hasConflicts", "memberCount"],
      "properties": {
        "convoId": { "type": "string" },
        "hasConflicts": { "type": "boolean" },
        "memberCount": { "type": "integer", "minimum": 0 },
        "checkedAt": { "type": "string", "format": "datetime" }
      }
    }
  }
}
