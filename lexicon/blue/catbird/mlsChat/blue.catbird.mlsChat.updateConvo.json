{
  "lexicon": 1,
  "id": "blue.catbird.mlsChat.updateConvo",
  "description": "Update conversation settings (consolidates updatePolicy + promoteAdmin + demoteAdmin + promoteModerator + demoteModerator + updateGroupInfo + groupInfoRefresh)",
  "defs": {
    "main": {
      "type": "procedure",
      "description": "Perform administrative actions on a conversation. The 'action' field determines the operation. Most actions require admin privileges.",
      "input": {
        "encoding": "application/json",
        "schema": {
          "type": "object",
          "required": ["convoId", "action"],
          "properties": {
            "convoId": {
              "type": "string",
              "description": "Conversation identifier"
            },
            "action": {
              "type": "string",
              "description": "Action to perform on the conversation",
              "knownValues": [
                "updatePolicy",
                "promoteAdmin",
                "demoteAdmin",
                "promoteModerator",
                "demoteModerator",
                "updateGroupInfo",
                "refreshGroupInfo"
              ]
            },
            "targetDid": {
              "type": "string",
              "format": "did",
              "description": "Target member DID (required for promote/demote actions)"
            },
            "policy": {
              "type": "ref",
              "ref": "#policyInput",
              "description": "Policy settings to update (required for 'updatePolicy' action)"
            },
            "groupInfo": {
              "type": "string",
              "description": "Base64-encoded serialized GroupInfo bytes (required for 'updateGroupInfo' action)"
            },
            "epoch": {
              "type": "integer",
              "minimum": 0,
              "description": "MLS epoch the GroupInfo corresponds to (required for 'updateGroupInfo' action)"
            }
          }
        }
      },
      "output": {
        "encoding": "application/json",
        "schema": {
          "type": "object",
          "required": ["success"],
          "properties": {
            "success": {
              "type": "boolean",
              "description": "Whether the operation succeeded"
            },
            "newEpoch": {
              "type": "integer",
              "minimum": 0,
              "description": "New epoch number (if the action caused an epoch change)"
            },
            "policy": {
              "type": "ref",
              "ref": "#policyView",
              "description": "Updated policy settings (present when action is 'updatePolicy')"
            }
          }
        }
      },
      "errors": [
        {"name": "ConvoNotFound", "description": "Conversation not found"},
        {"name": "NotMember", "description": "Caller is not a member of this conversation"},
        {"name": "Unauthorized", "description": "Caller does not have required admin/moderator privileges"},
        {"name": "InvalidAction", "description": "Unknown action value"},
        {"name": "MissingTargetDid", "description": "targetDid is required for promote/demote actions"},
        {"name": "TargetNotMember", "description": "Target DID is not a member of the conversation"},
        {"name": "NoFieldsProvided", "description": "At least one policy field must be provided for updatePolicy"},
        {"name": "InvalidGroupInfo", "description": "Provided GroupInfo is invalid or malformed"},
        {"name": "InvalidMaxMembers", "description": "maxMembers is less than current member count"}
      ]
    },
    "policyInput": {
      "type": "object",
      "description": "Policy settings to update (at least one field required)",
      "properties": {
        "allowInvites": {
          "type": "boolean",
          "description": "Whether invite links are enabled"
        },
        "adminOnlyInvites": {
          "type": "boolean",
          "description": "Whether only admins can create invite links"
        },
        "allowMemberAdd": {
          "type": "boolean",
          "description": "Whether non-admin members can add other members"
        },
        "allowMemberRemove": {
          "type": "boolean",
          "description": "Whether non-admin members can remove other members"
        },
        "requireAdminApproval": {
          "type": "boolean",
          "description": "Whether new members require admin approval"
        },
        "maxMembers": {
          "type": "integer",
          "minimum": 2,
          "maximum": 1000,
          "description": "Maximum number of members allowed"
        }
      }
    },
    "policyView": {
      "type": "object",
      "required": ["convoId", "allowInvites", "adminOnlyInvites", "allowMemberAdd", "allowMemberRemove", "requireAdminApproval", "maxMembers", "updatedAt"],
      "properties": {
        "convoId": {
          "type": "string",
          "description": "Conversation identifier"
        },
        "allowInvites": { "type": "boolean" },
        "adminOnlyInvites": { "type": "boolean" },
        "allowMemberAdd": { "type": "boolean" },
        "allowMemberRemove": { "type": "boolean" },
        "requireAdminApproval": { "type": "boolean" },
        "maxMembers": {
          "type": "integer",
          "minimum": 2,
          "maximum": 1000
        },
        "updatedAt": {
          "type": "string",
          "format": "datetime",
          "description": "Timestamp of last policy update"
        },
        "updatedBy": {
          "type": "string",
          "format": "did",
          "description": "DID of admin who last updated the policy"
        }
      }
    }
  }
}
