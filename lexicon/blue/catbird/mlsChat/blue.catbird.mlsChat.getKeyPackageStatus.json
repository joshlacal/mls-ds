{
  "lexicon": 1,
  "id": "blue.catbird.mlsChat.getKeyPackageStatus",
  "description": "Get key package statistics and status for the authenticated user's devices",
  "defs": {
    "main": {
      "type": "query",
      "description": "Retrieve key package counts, status, and history for the authenticated user. Useful for clients to know when to replenish key packages.",
      "parameters": {
        "type": "params",
        "properties": {
          "did": {
            "type": "string",
            "format": "did",
            "description": "DID to check status for (defaults to authenticated user)"
          },
          "cipherSuite": {
            "type": "string",
            "description": "Filter by cipher suite"
          },
          "include": {
            "type": "string",
            "description": "Comma-separated sections to include",
            "default": "stats",
            "knownValues": ["stats", "status", "history"]
          },
          "limit": {
            "type": "integer",
            "minimum": 1,
            "maximum": 100,
            "default": 50,
            "description": "Maximum results for status/history sections"
          },
          "cursor": {
            "type": "string",
            "description": "Pagination cursor"
          }
        }
      },
      "output": {
        "encoding": "application/json",
        "schema": {
          "type": "object",
          "properties": {
            "stats": {
              "type": "ref",
              "ref": "#keyPackageStats"
            },
            "status": {
              "type": "array",
              "items": {
                "type": "ref",
                "ref": "#keyPackageStatusItem"
              }
            },
            "history": {
              "type": "array",
              "items": {
                "type": "ref",
                "ref": "#keyPackageHistoryItem"
              }
            },
            "cursor": {
              "type": "string"
            }
          }
        }
      }
    },
    "keyPackageStats": {
      "type": "object",
      "required": ["totalAvailable", "totalConsumed"],
      "properties": {
        "totalAvailable": { "type": "integer", "minimum": 0 },
        "totalConsumed": { "type": "integer", "minimum": 0 },
        "byDevice": {
          "type": "array",
          "items": {
            "type": "ref",
            "ref": "#deviceKeyPackageCount"
          }
        }
      }
    },
    "deviceKeyPackageCount": {
      "type": "object",
      "required": ["deviceId", "available"],
      "properties": {
        "deviceId": { "type": "string" },
        "available": { "type": "integer", "minimum": 0 }
      }
    },
    "keyPackageStatusItem": {
      "type": "object",
      "required": ["id", "deviceId", "cipherSuite", "createdAt", "consumed"],
      "properties": {
        "id": { "type": "string" },
        "deviceId": { "type": "string" },
        "cipherSuite": { "type": "string" },
        "createdAt": { "type": "string", "format": "datetime" },
        "expiresAt": { "type": "string", "format": "datetime" },
        "consumed": { "type": "boolean" }
      }
    },
    "keyPackageHistoryItem": {
      "type": "object",
      "required": ["id", "action", "createdAt"],
      "properties": {
        "id": { "type": "string" },
        "action": { "type": "string", "knownValues": ["uploaded", "consumed", "expired"] },
        "createdAt": { "type": "string", "format": "datetime" },
        "consumedByDid": { "type": "string", "format": "did" }
      }
    }
  }
}
