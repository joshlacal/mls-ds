{
  "lexicon": 1,
  "id": "blue.catbird.mlsChat.registerDevice",
  "description": "Consolidated device registration with optional push token (replaces registerDevice + registerDeviceToken)",
  "defs": {
    "main": {
      "type": "procedure",
      "description": "Register a device for multi-device MLS support. Each device gets a unique device ID and credential (did:plc:user#device-uuid). Optionally registers a push token in the same call, eliminating the need for a separate registerDeviceToken request.",
      "input": {
        "encoding": "application/json",
        "schema": {
          "type": "object",
          "required": ["deviceName", "keyPackages", "signaturePublicKey"],
          "properties": {
            "deviceName": {
              "type": "string",
              "description": "Human-readable device name (e.g., 'Josh's iPhone', 'MacBook Pro')",
              "minLength": 1,
              "maxLength": 100
            },
            "deviceUUID": {
              "type": "string",
              "description": "Persistent device UUID (stored in iCloud Keychain). Allows server to detect device re-registration and cleanup old key packages. Optional for backward compatibility."
            },
            "keyPackages": {
              "type": "array",
              "description": "MLS key packages for this device (1-200 packages)",
              "minItems": 1,
              "maxItems": 200,
              "items": {
                "type": "ref",
                "ref": "#keyPackageItem"
              }
            },
            "signaturePublicKey": {
              "type": "bytes",
              "description": "Device Ed25519 signature public key (32 bytes)",
              "maxLength": 32
            },
            "pushToken": {
              "type": "string",
              "description": "Optional APNS/FCM push token for this device. If provided, registers the push token in the same atomic operation as device registration.",
              "maxLength": 512
            }
          }
        }
      },
      "output": {
        "encoding": "application/json",
        "schema": {
          "type": "object",
          "required": ["deviceId", "mlsDid", "autoJoinedConvos"],
          "properties": {
            "deviceId": {
              "type": "string",
              "description": "Server-generated device ID (UUID)"
            },
            "mlsDid": {
              "type": "string",
              "description": "Full device credential DID (did:plc:user#device-uuid). Use this as the MLS credential identity."
            },
            "autoJoinedConvos": {
              "type": "array",
              "description": "Conversation IDs that this device can auto-join",
              "items": {
                "type": "string"
              }
            },
            "welcomeMessages": {
              "type": "array",
              "description": "Welcome messages for auto-joining conversations (may be empty)",
              "items": {
                "type": "ref",
                "ref": "#welcomeMessage"
              }
            }
          }
        }
      },
      "errors": [
        {"name": "InvalidDeviceName"},
        {"name": "InvalidKeyPackages"},
        {"name": "InvalidSignatureKey"},
        {"name": "DeviceAlreadyRegistered"},
        {"name": "TooManyDevices"}
      ]
    },
    "keyPackageItem": {
      "type": "object",
      "required": ["keyPackage", "cipherSuite", "expires"],
      "properties": {
        "keyPackage": {
          "type": "string",
          "description": "Base64-encoded MLS key package"
        },
        "cipherSuite": {
          "type": "string",
          "description": "MLS cipher suite (e.g., 'MLS_128_DHKEMX25519_AES128GCM_SHA256_Ed25519')"
        },
        "expires": {
          "type": "string",
          "format": "datetime",
          "description": "Key package expiration time"
        }
      }
    },
    "welcomeMessage": {
      "type": "object",
      "required": ["convoId", "welcome"],
      "properties": {
        "convoId": {
          "type": "string",
          "description": "Conversation ID"
        },
        "welcome": {
          "type": "string",
          "description": "Base64-encoded MLS Welcome message"
        }
      }
    }
  }
}
