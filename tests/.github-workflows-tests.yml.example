# GitHub Actions workflow for MLS Integration Tests
# Copy to .github/workflows/tests.yml to enable

name: MLS Integration Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  CARGO_TERM_COLOR: always

jobs:
  ios-tests:
    name: iOS Tests
    runs-on: macos-13
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: '15.0'
    
    - name: Cache Swift packages
      uses: actions/cache@v3
      with:
        path: ~/Library/Developer/Xcode/DerivedData
        key: ${{ runner.os }}-spm-${{ hashFiles('**/Package.resolved') }}
        restore-keys: |
          ${{ runner.os }}-spm-
    
    - name: Run iOS tests
      working-directory: ./client-ios/CatbirdChat
      run: |
        xcodebuild test \
          -scheme CatbirdChat \
          -destination 'platform=iOS Simulator,name=iPhone 15' \
          -enableCodeCoverage YES \
          -resultBundlePath test-results
    
    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: ios-test-results
        path: client-ios/CatbirdChat/test-results
    
    - name: Generate coverage report
      run: |
        xcrun xccov view --report --json test-results/*.xcresult > coverage.json
      working-directory: ./client-ios/CatbirdChat
    
    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        files: ./client-ios/CatbirdChat/coverage.json
        flags: ios
        name: ios-coverage

  server-tests:
    name: Server Tests
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: catbird_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Setup Rust
      uses: actions-rs/toolchain@v1
      with:
        profile: minimal
        toolchain: stable
        override: true
        components: rustfmt, clippy
    
    - name: Cache cargo registry
      uses: actions/cache@v3
      with:
        path: ~/.cargo/registry
        key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}
    
    - name: Cache cargo index
      uses: actions/cache@v3
      with:
        path: ~/.cargo/git
        key: ${{ runner.os }}-cargo-index-${{ hashFiles('**/Cargo.lock') }}
    
    - name: Cache cargo build
      uses: actions/cache@v3
      with:
        path: server/target
        key: ${{ runner.os }}-cargo-build-target-${{ hashFiles('**/Cargo.lock') }}
    
    - name: Check formatting
      run: cargo fmt -- --check
      working-directory: ./server
    
    - name: Run clippy
      run: cargo clippy -- -D warnings
      working-directory: ./server
    
    - name: Run tests
      env:
        DATABASE_URL: postgres://postgres:postgres@localhost:5432/catbird_test
      run: cargo test --verbose
      working-directory: ./server
    
    - name: Generate coverage
      run: |
        cargo install cargo-tarpaulin
        cargo tarpaulin --out Xml --output-dir ../test-reports
      working-directory: ./server
    
    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        files: ./test-reports/cobertura.xml
        flags: server
        name: server-coverage

  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [ios-tests, server-tests]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Validate test structure
      run: |
        echo "Checking test files..."
        test -f tests/fixtures/TestData.swift
        test -f tests/mocks/MockMLSServer.swift
        test -f tests/ios/MLSGroupTests.swift
        test -f tests/ios/MLSMessagingTests.swift
        test -f tests/ios/MLSKeyRotationTests.swift
        test -f tests/ios/MLSMultiDeviceTests.swift
        test -f tests/ios/MLSOfflineErrorTests.swift
        test -f tests/server/e2e_integration_tests.rs
        echo "✅ All test files present"
    
    - name: Generate test report
      run: |
        echo "# Test Suite Summary" > test-summary.md
        echo "" >> test-summary.md
        echo "✅ iOS Tests: Passed" >> test-summary.md
        echo "✅ Server Tests: Passed" >> test-summary.md
        echo "✅ Integration Tests: Validated" >> test-summary.md
    
    - name: Upload test summary
      uses: actions/upload-artifact@v3
      with:
        name: test-summary
        path: test-summary.md

  coverage-report:
    name: Coverage Report
    runs-on: ubuntu-latest
    needs: [ios-tests, server-tests]
    if: always()
    
    steps:
    - name: Download iOS coverage
      uses: actions/download-artifact@v3
      with:
        name: ios-test-results
      continue-on-error: true
    
    - name: Generate combined report
      run: |
        echo "# Combined Coverage Report" > coverage-report.md
        echo "" >> coverage-report.md
        echo "See individual coverage reports for details:" >> coverage-report.md
        echo "- iOS: Check Codecov for ios-coverage" >> coverage-report.md
        echo "- Server: Check Codecov for server-coverage" >> coverage-report.md
    
    - name: Upload coverage report
      uses: actions/upload-artifact@v3
      with:
        name: coverage-report
        path: coverage-report.md
    
    - name: Comment PR
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v6
      with:
        script: |
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: '✅ All tests passed! See workflow artifacts for detailed results.'
          })

  notify:
    name: Notify on Failure
    runs-on: ubuntu-latest
    needs: [ios-tests, server-tests, integration-tests]
    if: failure()
    
    steps:
    - name: Notify failure
      run: |
        echo "❌ Tests failed! Please check the workflow logs."
        exit 1
