# External Commits: Quick Reference

**TL;DR**: Enable instant rejoin (<500ms) instead of waiting for another client (2-5 seconds)

---

## Overview

### Current Flow (Request & Wait)
```
Client ‚Üí Upload KeyPackage ‚Üí Wait for other client ‚Üí Receive Welcome ‚Üí Rejoin
‚è±Ô∏è 2-5 seconds (or indefinite if no clients online)
```

### New Flow (External Commit)
```
Client ‚Üí Fetch GroupInfo ‚Üí Generate commit ‚Üí Submit ‚Üí Rejoined
‚ö° <500ms (no waiting)
```

---

## Key Concepts

**GroupInfo**: Public group state snapshot (signed, can't be forged)
- Contains: Current epoch, ratchet tree, group config
- Cached on server, regenerated on each commit
- 5-minute TTL (stays fresh)

**External Commit**: MLS feature (RFC 9420) to self-add without existing member
- Generated by rejoining client using GroupInfo
- Server validates before accepting
- Standard protocol, not custom hack

---

## API Endpoints

### 1. Get GroupInfo
```http
POST /xrpc/blue.catbird.mls.getGroupInfo
Content-Type: application/json

{
  "convoId": "conversation-uuid"
}
```

**Response:**
```json
{
  "groupInfo": "base64-encoded-bytes",
  "epoch": 42,
  "expiresAt": "2025-11-19T10:00:00Z"
}
```

**Authorization:**
- Current members: ‚úÖ Allowed
- Past members (left <30 days ago): ‚úÖ Allowed  
- Past members (left >30 days ago): ‚ùå Denied
- Never was member: ‚ùå Denied
- Banned users: ‚ùå Denied

---

### 2. Process External Commit
```http
POST /xrpc/blue.catbird.mls.processExternalCommit
Content-Type: application/json

{
  "convoId": "conversation-uuid",
  "externalCommit": "base64-encoded-mls-message"
}
```

**Response:**
```json
{
  "success": true,
  "epoch": 43,
  "rejoinedAt": "2025-11-19T09:54:56Z"
}
```

**Validation:**
- Commit signature valid
- Adds correct user's device
- User authorized to rejoin
- Epoch matches current state

---

## Client Usage (Swift)

```swift
// Simple rejoin (handles fallback automatically)
try await conversationManager.rejoinConversation(conversationId)

// Explicit external commit
let groupInfoResp = try await api.getGroupInfo(convoId: convoId)
let groupInfo = Data(base64Encoded: groupInfoResp.groupInfo)!
let group = try await mlsClient.joinByExternalCommit(
    groupInfo: groupInfo,
    conversationId: convoId
)
```

---

## Server Implementation Checklist

- [ ] Upgrade OpenMLS to 0.7.1
- [ ] Add `group_info` columns to `conversations` table
- [ ] Implement `generate_and_cache_group_info()`
- [ ] Update all commit handlers to regenerate GroupInfo
- [ ] Implement `getGroupInfo` handler
- [ ] Implement `processExternalCommit` handler
- [ ] Add authorization checks
- [ ] Register routes in router
- [ ] Write tests
- [ ] Deploy with feature flag

---

## Client Implementation Checklist

- [ ] Add FFI wrapper for `join_by_external_commit()`
- [ ] Implement `getGroupInfo` API call
- [ ] Implement `processExternalCommit` API call
- [ ] Add rejoin orchestration logic
- [ ] Implement fallback to legacy rejoin
- [ ] Add retry logic for epoch mismatch
- [ ] Auto-detect missing conversations on launch
- [ ] Write tests
- [ ] Gradual rollout with feature flag

---

## Security Notes

‚úÖ **Maintains all MLS properties:**
- Forward secrecy (new keys, can't decrypt past messages)
- Post-compromise security
- Authentication (GroupInfo is signed)
- Authorization (server enforces policy)

‚ö†Ô∏è **Server policy matters:**
- 30-day grace period for rejoins (configurable)
- Banned users blocked
- Rate limiting (5 rejoins/hour per user per convo)

üîí **Attack vectors:**
- Spammy rejoins: Rate limiting prevents
- Unauthorized rejoin: Server validates membership
- Forged GroupInfo: Cryptographic signature prevents

---

## Performance

**Metrics:**
- External commit latency: <500ms (P99)
- Success rate: >99%
- Fallback rate: <1%

**Load test results** (example):
```
100 concurrent rejoins/second
- Average: 320ms
- P95: 480ms
- P99: 650ms
- Success rate: 99.8%
```

---

## Troubleshooting

| Error | Cause | Fix |
|-------|-------|-----|
| `GroupInfoUnavailable` | Not cached yet | Regenerate after convo creation |
| `EpochMismatch` | Stale GroupInfo | Client auto-retries |
| `Unauthorized` | Not a member or banned | Check membership policy |
| `InvalidCommit` | Serialization issue | Check base64 encoding |

---

## Monitoring

**Prometheus metrics:**
```
external_commit_requests_total
external_commit_success_total
external_commit_latency_seconds
external_commit_epoch_mismatch_total
```

**Key queries:**
```sql
-- Success rate
SELECT success_rate FROM external_commit_stats WHERE timestamp > NOW() - INTERVAL '1 hour';

-- Average latency
SELECT AVG(latency_ms) FROM external_commit_logs WHERE created_at > NOW() - INTERVAL '1 hour';
```

---

## Rollout Plan

**Phase 1**: Internal testing (100 users, 1 week)
**Phase 2**: Beta users (10%, 1 week)
**Phase 3**: Gradual rollout (10% ‚Üí 50% ‚Üí 100%, 1 week)
**Phase 4**: Full release

**Rollback plan:**
- Disable feature flag
- Automatic fallback to legacy rejoin
- No data loss (both methods supported)

---

## Comparison: External Commit vs Legacy Rejoin

| Feature | Legacy Rejoin | External Commit |
|---------|--------------|-----------------|
| **Latency** | 2-5 seconds | <500ms |
| **Dependency** | Another client online | Server only |
| **Offline scenario** | Blocks indefinitely | N/A (needs server) |
| **Complexity** | Higher (coordination) | Lower (direct) |
| **Protocol** | Custom flow | Standard MLS |
| **Security** | ‚úÖ Full E2EE | ‚úÖ Full E2EE |
| **Forward secrecy** | ‚úÖ Maintained | ‚úÖ Maintained |
| **Server knowledge** | Zero-knowledge | Zero-knowledge |

---

## FAQ

**Q: Can users rejoin if banned?**  
A: No, `processExternalCommit` checks `banned_at` field.

**Q: What if GroupInfo is stale during rejoin?**  
A: Client gets `EpochMismatch`, refetches fresh GroupInfo, retries.

**Q: Does this break E2EE?**  
A: No. Rejoining device gets NEW keys, can't decrypt past messages.

**Q: Can server read messages with this?**  
A: No. GroupInfo is public metadata, doesn't contain message keys.

**Q: What about offline scenarios?**  
A: External commits require server. For offline, use cached Welcome messages (different feature).

**Q: Should we keep legacy rejoin?**  
A: Yes, for backwards compatibility and fallback. Deprecate after 100% rollout.

---

## Resources

- [RFC 9420: MLS Protocol](https://www.rfc-editor.org/rfc/rfc9420.html)
- [OpenMLS Documentation](https://openmls.tech)
- [Implementation Plan](./EXTERNAL_COMMITS_IMPLEMENTATION_PLAN.md)
- [Implementation Guide](./EXTERNAL_COMMITS_IMPLEMENTATION_GUIDE.md)

---

**Last Updated**: 2025-11-19  
**Status**: Ready for implementation  
**Owner**: Engineering team
